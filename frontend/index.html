<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MSME Agent Playground</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen p-6">

<div class="max-w-5xl mx-auto space-y-6">

  <!-- Header -->
  <div class="bg-white p-6 rounded-xl shadow">
    <h1 class="text-2xl font-bold">üß† MSME Agent Playground</h1>
    <p class="text-gray-600 text-sm">
      Structured testing interface for agent behavior
    </p>
  </div>

  <!-- MODE SELECTOR -->
  <div class="bg-white p-6 rounded-xl shadow space-y-4">
    <h2 class="font-semibold">Input Mode</h2>
    <div class="flex gap-4">
      <label class="flex items-center gap-2">
        <input type="radio" name="mode" value="FORM" checked onclick="switchMode('FORM')" />
        Structured Form
      </label>
      <label class="flex items-center gap-2">
        <input type="radio" name="mode" value="TEXT" onclick="switchMode('TEXT')" />
        Free Text
      </label>
    </div>
  </div>

  <!-- STRUCTURED FORM -->
  <div id="formMode" class="bg-white p-6 rounded-xl shadow space-y-4">
    <h2 class="font-semibold">Structured Action</h2>

    <select id="intent" class="w-full p-2 border rounded" onchange="renderFormFields()">
      <option value="">Select action</option>
      <option value="NEW_ORDER">New Order</option>
      <option value="CANCEL_ORDER">Cancel Order</option>
      <option value="CHECK_STATUS">Check Order Status</option>
    </select>

    <div id="dynamicFields" class="space-y-3"></div>

    <button
      onclick="submitForm()"
      class="bg-blue-600 text-white px-5 py-2 rounded hover:bg-blue-700"
    >
      ‚ñ∂ Submit Structured Request
    </button>
  </div>

  <!-- FREE TEXT MODE -->
  <div id="textMode" class="bg-white p-6 rounded-xl shadow space-y-4 hidden">
    <h2 class="font-semibold">Free Text Input</h2>

    <textarea
      id="freeText"
      rows="4"
      class="w-full p-3 border rounded"
      placeholder="Enter user message..."
    ></textarea>

    <button
      onclick="submitText()"
      class="bg-blue-600 text-white px-5 py-2 rounded hover:bg-blue-700"
    >
      ‚ñ∂ Run Agent
    </button>
  </div>

  <!-- OUTPUT -->
  <div id="output" class="space-y-4"></div>

</div>

<script>
  let lastRequestPayload = null;

  function switchMode(mode) {
    document.getElementById("formMode").classList.toggle("hidden", mode !== "FORM");
    document.getElementById("textMode").classList.toggle("hidden", mode !== "TEXT");
    document.getElementById("output").innerHTML = "";
  }

  function renderFormFields() {
    const intent = document.getElementById("intent").value;
    const container = document.getElementById("dynamicFields");
    container.innerHTML = "";

    if (intent === "NEW_ORDER") {
      container.innerHTML = `
        <input id="product" class="w-full p-2 border rounded" placeholder="Product name" />
        <input id="quantity" type="number" class="w-full p-2 border rounded" placeholder="Quantity" />
      `;
    }

    if (intent === "CANCEL_ORDER" || intent === "CHECK_STATUS") {
      container.innerHTML = `
        <input id="order_id" class="w-full p-2 border rounded" placeholder="Order ID" />
      `;
    }
  }

  async function submitForm() {
    const intent = document.getElementById("intent").value;
    if (!intent) return alert("Select an action");

    const payload = {
      input_mode: "FORM",
      intent: intent,
      entities: {},
      user_input: "[FORM INPUT]"
    };

    if (intent === "NEW_ORDER") {
      payload.entities.product = document.getElementById("product").value;
      payload.entities.quantity = Number(document.getElementById("quantity").value);
    }

    if (intent === "CANCEL_ORDER" || intent === "CHECK_STATUS") {
      payload.entities.order_id = document.getElementById("order_id").value;
    }

    send(payload);
  }

  async function submitText() {
    const text = document.getElementById("freeText").value.trim();
    if (!text) return alert("Enter text");

    send({
      input_mode: "TEXT",
      user_input: text,
      intent: null,
      entities: {}
    });
  }

  function retryLastRequest() {
    if (!lastRequestPayload) {
      alert("No request to retry.");
      return;
    }
    send(lastRequestPayload);
  }

  async function send(payload) {
    lastRequestPayload = JSON.parse(JSON.stringify(payload));

    const output = document.getElementById("output");
    output.innerHTML = "<div class='bg-white p-4 rounded shadow'>‚è≥ Processing...</div>";

    const res = await fetch("/process", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    const status = data.action_result?.status || "unknown";
    const confidence = Math.round((data.confidence ?? 0) * 100);

    const statusColor =
      status === "success" ? "bg-green-100" :
      status === "blocked" ? "bg-red-100" :
      "bg-yellow-100";

    output.innerHTML = `
      <div class="bg-white p-5 rounded-xl shadow space-y-4">

        <div class="${statusColor} p-3 rounded font-semibold">
          ${status.toUpperCase()}
        </div>

        <div>
          <b>Intent:</b> ${data.intent}<br/>
          <b>Decision:</b> ${data.decision}
        </div>

        <!-- CONFIDENCE -->
        <div>
          <b> Decision Confidence</b>
          <div class="w-full bg-gray-200 rounded h-3 mt-1">
            <div
              class="h-3 rounded ${
                confidence > 70 ? "bg-green-500" :
                confidence > 40 ? "bg-yellow-500" :
                "bg-red-500"
              }"
              style="width: ${confidence}%"
            ></div>
          </div>
          <div class="text-sm mt-1">
            ${confidence}% ${
              confidence < 50
                ? " Reduced confidence due to past failures"
                : ""
            }
          </div>
        </div>

        <div>
          <b> Reasoning Summary</b>
          <div class="bg-blue-50 p-3 rounded mt-1">
            ${data.reasoning_summary || "‚Äî"}
          </div>
        </div>

        ${
          data.plan
            ? `
            <div>
              <b> Recovery Plan</b>
              <pre class="bg-green-50 p-3 rounded mt-1 whitespace-pre-wrap">
${data.plan}
              </pre>
            </div>
            `
            : ""
        }

        ${
          status === "blocked"
            ? `
            <button
              onclick="retryLastRequest()"
              class="bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700"
            >
               Retry After Plan
            </button>
            `
            : ""
        }

        <details>
          <summary class="cursor-pointer font-semibold">üìú Logs</summary>
          <ul class="list-disc pl-5 mt-2 text-sm">
            ${data.logs.map(l => `<li>${l}</li>`).join("")}
          </ul>
        </details>

      </div>
    `;
  }
</script>

</body>
</html>
